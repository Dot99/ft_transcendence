<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Play</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/style.css">
</head>
<body class="bg-[#07303c] min-h-screen flex items-center justify-center" style="font-family: 'Press Start 2P', cursive;">
  <div class="relative w-full h-[600px] flex items-center justify-center">

    <!-- Top Trophy and Arrows -->
    <div class="fixed top-2 left-1/2 -translate-x-1/2 flex items-center space-x-6 z-50">
      <img src="images/arrow.svg" class="w-6 h-6 rotate-180" alt="arrow">
      <img src="images/trophy.svg" class="w-14 h-14" alt="trophy">
      <img src="images/arrow.svg" class="w-6 h-6" alt="arrow">
    </div>

    <!-- Left Player Panel -->
    <div class="fixed left-10 top-1/2 -translate-y-1/2 flex flex-col items-center w-48 z-30">
      <span id="player-username" class="text-[#4CF190] text-2xl mb-3">player</span>
      <div id="player-banner" class="border-4 border-[#4CF190] p-1 mb-3 w-28 h-28 flex items-center justify-center transition-all">
        <img id="player-avatar" src="images/avatar1.jpg" alt="Player" class="w-24 h-24 rounded" />
      </div>
      <div class="relative w-36 h-20 flex items-center justify-center mb-2">
        <img src="images/score.svg" class="absolute inset-0 w-full h-full" alt="score" />
        <span id="player-score" class="relative z-10 text-[#EFD671] text-xl flex items-center justify-center w-full h-full text-center" style="margin-left:32px;">09</span>
      </div>
    </div>

    <!-- Right Player Panel -->
    <div class="fixed right-10 top-1/2 -translate-y-1/2 flex flex-col items-center w-48 z-30">
      <span class="text-[#4CF190] text-2xl mb-3">Bot</span>
      <div id="bot-banner" class="border-4 border-[#4CF190] p-1 mb-3 w-28 h-28 flex items-center justify-center transition-all">
        <img src="images/robot.svg" alt="Bot" class="w-24 h-24 rounded" />
      </div>
      <div class="relative w-36 h-20 flex items-center justify-center mb-2">
        <img src="images/score.svg" class="absolute inset-0 w-full h-full" alt="score" />
        <span id="bot-score" class="relative z-10 text-[#EFD671] text-xl flex items-center justify-center w-full h-full text-center" style="margin-left:32px;">05</span>
      </div>
    </div>

    <!-- Pong Game Area -->
    <div class="relative w-[850px] h-[500px] border-4 border-[#4CF190] bg-[#07303c] flex items-center justify-center overflow-hidden z-10">
      <div class="absolute left-1/2 top-0 -translate-x-1/2 h-full flex flex-col items-center z-0 pointer-events-none">
        <div class="flex flex-col h-full justify-between py-2">
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
          <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
      <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
      <div class="w-1 h-8 bg-[#4CF190] mb-4 opacity-50"></div>
      <div class="w-1 h-8 bg-[#4CF190] opacity-50"></div>
        </div>
      </div>

      <!-- Dynamic pong game -->
      <canvas id="pong-canvas" width="850" height="500" class="absolute left-0 top-0 z-10"></canvas>
    </div>

    <!-- Bottom Center Arcade Logo -->
    <div class="fixed left-1/2 -translate-x-1/2 bottom-8 flex flex-col items-center -mb-24 z-50">
      <img src="images/logo.svg" class="w-48 h-48" alt="arcade">
    </div>
  </div>

  <script>
    // Fetch user info and update the player panel
    fetch('/api/user/1')
      .then(res => res.json())
      .then(user => {
        document.getElementById('player-username').textContent = user.username || 'Player';
        document.getElementById('player-avatar').src = 'images/' + (user.pfp || 'avatar1.jpg');
      });

    const canvas = document.getElementById('pong-canvas');
    const ctx = canvas.getContext('2d');

    const paddleWidth = 16, paddleHeight = 64, paddleSpeed = 6;
    const ballWidth = 20, ballHeight = 20, ballSpeed = 4; // slower ball
    const fieldWidth = canvas.width, fieldHeight = canvas.height;

    let leftY = fieldHeight/2 - paddleHeight/2;
    let rightY = fieldHeight/2 - paddleHeight/2;
    let ballX = fieldWidth/2 - ballWidth/2, ballY = fieldHeight/2 - ballHeight/2;
    let ballVX = 0, ballVY = 0; // Start stopped
    let leftScore = 0, rightScore = 0;
    let gameStarted = false;
    const keys = { w: false, s: false, ArrowUp: false, ArrowDown: false };

    let winner = null;
    let winnerScoreInterval = null;

    // Listen for spacebar
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        startGame();
      }
      if (e.key === 'w' || e.key === 's' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        keys[e.key] = true;
      }
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'w' || e.key === 's' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        keys[e.key] = false;
      }
    });

    function setBannerGlow(winnerSide) {
      document.getElementById('player-banner').classList.remove('winner-banner');
      document.getElementById('bot-banner').classList.remove('winner-banner');
      document.getElementById('player-score').classList.remove('score-glow-winner');
      document.getElementById('bot-score').classList.remove('score-glow-winner');
      if (winnerSide === "left") {
        document.getElementById('player-banner').classList.add('winner-banner');
        document.getElementById('player-score').classList.add('score-glow-winner');
      } else if (winnerSide === "right") {
        document.getElementById('bot-banner').classList.add('winner-banner');
        document.getElementById('bot-score').classList.add('score-glow-winner');
      }
    }

    function clearBannerGlow() {
      document.getElementById('player-banner').classList.remove('winner-banner');
      document.getElementById('bot-banner').classList.remove('winner-banner');
      document.getElementById('player-score').classList.remove('score-glow-winner');
      document.getElementById('bot-score').classList.remove('score-glow-winner');
    }

    function startWinnerScoreLoop(winnerSide) {
      let scoreSpan = winnerSide === "left"
        ? document.getElementById('player-score')
        : document.getElementById('bot-score');
      let score = 10;
      winnerScoreInterval = setInterval(() => {
        score++;
        scoreSpan.textContent = score.toString().padStart(2, '0');
        if (score >= 99) {
          clearInterval(winnerScoreInterval);
          winnerScoreInterval = null;
        }
      }, 20);
    }

    function stopWinnerScoreLoop() {
      if (winnerScoreInterval) {
        clearInterval(winnerScoreInterval);
        winnerScoreInterval = null;
      }
    }

    function startGame() {
      if (winner) {
        stopWinnerScoreLoop();
        clearBannerGlow();
        winner = null;
        resetGame();
      }
      if (!gameStarted && !winner) {
        gameStarted = true;
        ballVX = ballSpeed * (Math.random() > 0.5 ? 1 : -1);
        ballVY = ballSpeed * (Math.random() * 2 - 1);
      }
    }

    function resetBall() {
      ballX = fieldWidth / 2 - ballWidth / 2;
      ballY = fieldHeight / 2 - ballHeight / 2;
      ballVX = 0;
      ballVY = 0;
      gameStarted = false;
    }

    function resetGame() {
      leftScore = 0;
      rightScore = 0;
      updateScoreDisplay();
      leftY = fieldHeight/2 - paddleHeight/2;
      rightY = fieldHeight/2 - paddleHeight/2;
      resetBall();
    }

    // Helper to draw rectangles
    function rect(ctx, x, y, w, h) {
      ctx.beginPath();
      ctx.rect(x, y, w, h);
      ctx.closePath();
      ctx.fill();
    }

    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
      ctx.fill();
    }

    function update() {
      // Player paddle (left, controlled by WS)
      if (keys.w) leftY -= paddleSpeed;
      if (keys.s) leftY += paddleSpeed;
      leftY = Math.max(0, Math.min(fieldHeight - paddleHeight, leftY));

      // Player paddle (right, controlled by arrows)
      if (keys.ArrowUp) rightY -= paddleSpeed;
      if (keys.ArrowDown) rightY += paddleSpeed;
      rightY = Math.max(0, Math.min(fieldHeight - paddleHeight, rightY));

      if (!gameStarted) return;

      // Move ball
      ballX += ballVX;
      ballY += ballVY;

      // Ball collision with top/bottom
      if (ballY <= 0 || ballY + ballHeight >= fieldHeight) ballVY *= -1;

      // Ball collision with paddles
      // Left paddle
      if (
        ballX <= 32 &&
        ballY + ballHeight > leftY &&
        ballY < leftY + paddleHeight
      ) {
        ballVX = Math.abs(ballVX);
        ballVY += (ballY + ballHeight/2 - (leftY + paddleHeight/2)) * 0.15;
      }
      // Right paddle
      if (
        ballX + ballWidth >= fieldWidth - 32 &&
        ballY + ballHeight > rightY &&
        ballY < rightY + paddleHeight
      ) {
        ballVX = -Math.abs(ballVX);
        ballVY += (ballY + ballHeight/2 - (rightY + paddleHeight/2)) * 0.15;
      }

      // Score
      if (ballX < 0 && !winner) {
        rightScore++;
        updateScoreDisplay();
        if (rightScore >= 10) {
          winner = "right";
          setBannerGlow("right");
          startWinnerScoreLoop("right");
          resetGame();
        } else {
          resetBall();
        }
      }
      if (ballX + ballWidth > fieldWidth && !winner) {
        leftScore++;
        updateScoreDisplay();
        if (leftScore >= 10) {
          winner = "left";
          setBannerGlow("left");
          startWinnerScoreLoop("left");
          resetGame();
        } else {
          resetBall();
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, fieldWidth, fieldHeight);

      // Left paddle
      ctx.fillStyle = '#4CF190';
      rect(ctx, 16, leftY, paddleWidth, paddleHeight);

      // Right paddle
      ctx.fillStyle = '#4CF190';
      rect(ctx, fieldWidth - 16 - paddleWidth, rightY, paddleWidth, paddleHeight);

      // Ball
      ctx.fillStyle = '#4CF190';
      roundRect(ctx, ballX, ballY, ballWidth, ballHeight, 6);
    }

    function updateScoreDisplay() {
      document.querySelector('#player-score').textContent = leftScore.toString().padStart(2, '0');
      document.querySelector('#bot-score').textContent = rightScore.toString().padStart(2, '0');
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    // Initialize scores and ball
    updateScoreDisplay();
    resetBall();
    loop();
  </script>
</body>
</html>
